<!-- Modal -->
<div class="modal fade" id="firstSubmitModal" tabindex="-1" aria-labelledby="firstSubmitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content px-2">
            <div class="modal-header">
                <h5 class="modal-title" id="firstSubmitModalLabel">Submit as a draft</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" [formGroup]="firstSubmitForm">
                <div class="row mb-4">
                    <strong class="col-auto ms-2">Job identifier:</strong>
                    <span class="col-auto mx-2 badge bg-primary-dark">
                        {{firstSubmitForm.value["job_id"]}}
                    </span>
                </div>
                <div class="row mb-1">
                    <strong class="col-auto ms-2">Cover Letter:</strong>
                </div>
                <div class="row">
                    <div class="col input-group">
                        <textarea rows="4" class="form-control" [ngClass]="{'is-invalid': firstSubmitFormError}"
                            formControlName="cover_letter"
                            placeholder="Insert your comment (Minimum 50 characters long). Only for internal usage to inform biocurators."></textarea>
                        <div *ngIf="firstSubmitFormError" class="invalid-feedback">{{firstSubmitFormError}}</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button [attr.disabled]="isSubmitting?true:null" type="button" class="btn btn-primary"
                    (click)="submitFirst()">Submit</button>
            </div>
        </div>
    </div>
</div>

<!-- Main container -->
<div class="container-xl">
    <h2>Results</h2>
    <div class="alert alert-success">
        <div class="row px-2">
            <div class="col">
                <div class="row">
                    <p>
                        <strong>Job id:</strong>
                        <span class="mx-2 badge bg-primary-dark">
                            {{resultsService.currentUUID}}
                        </span>
                    </p>
                    <p>
                        <strong>Status:</strong>
                        <span class="mx-2 badge"
                            [ngClass]="{'bg-danger': jobObj.status === 'failed', 'bg-success': jobObj.status === 'done', 'bg-warning': jobObj.status === 'running', 'bg-dark': jobObj.status === 'expired' }">
                            {{jobObj.status}}
                        </span>
                        <strong class="ms-4">Creation Date:</strong>
                        <span class="mx-2">
                            {{formatTimestamp(jobObj.creation_date)}}
                        </span>
                    </p>
                    <p *ngIf="jobObj.parent_job_id">
                        <strong>Parent job:</strong>
                        <a class="mx-2 badge bg-primary" style="cursor: pointer;" role="button" target="_blank"
                            routerLink="/job/{{jobObj.parent_job_id}}">
                            {{jobObj.parent_job_id}} <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </p>
                    <p *ngIf="jobObj.linked_draft_id">
                        <strong>Linked draft:</strong>
                        <a class="mx-2 badge bg-primary" style="cursor: pointer;" role="button" target="_blank"
                            routerLink="/draft/{{jobObj.linked_draft_id}}">
                            {{jobObj.linked_draft_id}} <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                        <!-- <strong>(Job already submitted!)</strong> -->
                    </p>
                </div>
            </div>
            <div class="col-auto text-end me-2">
                <div class="row" *ngIf="jobObj.status==='done'">
                    <button type="button" class="btn btn-sm btn-primary mb-2" [routerLink]="['/submission']"
                        [queryParams]="{job_id: resultsService.currentUUID}">
                        <i class="bi bi-arrow-clockwise"></i> Resubmit from this
                    </button>
                </div>

                <div class="row" *ngIf="profileObj['role'] && jobObj.status==='done' && !jobObj.linked_draft_id">
                    <button  type="button" class="btn btn-sm btn-primary"
                        data-bs-toggle="modal" data-bs-target="#firstSubmitModal">
                        <i class="bi bi-arrow-up-circle me-1"></i> Upgrade to draft
                    </button>
                </div>

                <div class="row" *ngIf="profileObj['role'] && jobObj.status==='done' && jobObj.linked_draft_id && canOverwrite">
                    <button type="button" class="btn btn-sm btn-primary" (click)="overwriteDraft()">
                        <i class="bi bi-file-arrow-up me-1"></i> Overwrite draft
                    </button>
                </div>

                <div class="row" *ngIf="!profileObj['role'] && jobObj.status==='done'">
                    <app-login></app-login>
                </div>
            </div>
        </div>

    </div>

    <!-- Once it is done -->
    <ng-container *ngIf="jobObj && (['done'].includes(jobObj.status))">
        <app-result-page [entryObj]="resultsService.entryObj"></app-result-page>
    </ng-container>

    <!-- If have errors -->
    <ng-container *ngIf="jobObj && (['failed'].includes(jobObj.status)) && resultsService.errors">
        <div class="row mb-3" *ngFor="let currError of resultsService.errors">
            <div class="col">
                <p class="text-danger mb-0"><strong>Type of error: </strong> {{currError['title']}}</p>
                <p><strong>Message: </strong> <br>
                    <span [innerHTML]="currError['message']"></span>
                </p>
            </div>
        </div>
    </ng-container>

    <!-- While running -->
    <div class="row" *ngIf="jobObj && (['running'].includes(jobObj.status))">
        <div class="col-8 mx-auto text-center">
            <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
            Running...
        </div>
    </div>
</div>